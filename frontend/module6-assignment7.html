<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Module 6 — Assignment 7: What to do if you fall</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{
      --bg:#07102a; --card:#0f1724; --muted:#cfe5ff;
      --accent:#ff6b35; --success:#22c55e; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03); --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg), #021024);color:#e6f0ff;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 380px;gap:20px}
    .left,.right{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{margin:0;font-size:20px;color:var(--accent)}
    .sub{color:var(--muted);font-size:13px}
    .video-wrap{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .video-embed{width:100%;height:0;padding-bottom:56.25%;position:relative;border-radius:8px;overflow:hidden}
    .video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    form.quiz{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .question{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}
    .question h4{margin:0 0 8px;font-size:14px}
    .opt{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,0.02)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .note{font-size:13px;color:var(--muted)}
    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .stats{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.5),rgba(2,6,23,0.6))}
    .modal-inner{background:var(--card);padding:20px;border-radius:12px;width:360px;text-align:center}
    .close-btn{background:#fff;color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .progress-ring{width:200px;height:200px;margin:10px auto}
    .correct{border-left:6px solid var(--success)} .incorrect{border-left:6px solid var(--danger)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}.right{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <header>
        <div>
          <h1>Module 6 • Crowd Safety</h1>
          <div class="sub">Assignment 7 — What to do if you fall (Short)</div>
        </div>
        <div style="text-align:right">
          <div class="sub">Est. time: <strong>2–4 min</strong></div>
          <a class="btn ghost" href="module6.html" style="margin-top:8px;display:inline-block">Back to Module</a>
        </div>
      </header>

      <div class="video-wrap">
        <div class="video-embed" aria-hidden="false">
          <iframe src="https://www.youtube.com/embed/7YuRX0HliWQ" title="What to do if you fall" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>

      <form class="quiz" id="quizForm" aria-label="Quiz for Assignment 7"></form>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="note">Each question: <strong>1 mark</strong>. Total: 10 marks.</div>
        <div class="actions">
          <button class="btn" id="submitBtn" type="button">Submit Answers</button>
          <button class="btn ghost" id="clearBtn" type="button">Reset Answers</button>
        </div>
      </div>
    </div>

    <aside class="right" aria-label="Progress & Stats">
      <div class="card-title">
        <div><strong style="color:var(--muted)">Progress</strong><div style="font-size:12px;color:#bcd8ff">Module 6 — Crowd Safety</div></div>
        <div style="font-size:12px;color:var(--muted)">Assignment 7</div>
      </div>

      <div style="text-align:center">
        <svg viewBox="0 0 36 36" class="progress-ring" id="progressSvg" aria-hidden>
          <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#374151" stroke-width="3.5"></path>
          <path id="progressArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#22c55e" stroke-width="3.5" stroke-dasharray="0 100"></path>
          <text x="18" y="20.5" font-size="6" text-anchor="middle" fill="#fff" id="progressText">0%</text>
        </svg>
      </div>

      <div class="stats">
        <div class="stat"><div style="font-size:14px">Completed Assignments</div><div id="completedCount">0 / 15</div></div>
        <div class="stat"><div style="font-size:14px">Your score (this assignment)</div><div id="lastScore">—</div></div>
        <div class="stat"><div style="font-size:14px">Module Avg. (so far)</div><div id="avgScore">—</div></div>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">
        Tip: If you fall—protect head & neck first, then try to get to your feet quickly.
      </div>
    </aside>
  </div>

  <div class="modal" id="resultModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-inner" role="document">
      <h3>Result</h3>
      <p id="modalMsg">You scored X / 10</p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="close-btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Assignment 7 questions (Module 6)
    const QUESTIONS = [
      { q: "If you are in a dense crowd and people are starting to push you, what immediate physical action should you take to maximize your survival window?", options: [
          "Trying to push back against the crowd's flow to create a bubble of space.",
          "Folding your arms across your rib cage in the 'boxer stance'.",
          "Jumping up and down to assess the level of crowd density.",
          "Screaming loudly to alert security or emergency services."
        ], a: 1 },
      { q: "You arrive at a large, unfamiliar open-street festival. Based on the video, what should you do first as part of your Escape Plan?", options: [
          "Find the closest group of police officers or security personnel and stay near them.",
          "Establish a meeting point with your friends in case you get separated.",
          "Research the venue's overall safety rating to decide if you should stay.",
          "Locate the nearest exit points and mentally map out at least one clear escape route."
        ], a: 3 },
      { q: "If you are caught in a crowd surge moving in one direction, what is the best strategy to conserve energy while trying to get out?", options: [
          "Try to step over people's feet to make progress in the opposite direction.",
          "Move with the crowd's flow while gradually attempting to angle yourself toward the lower-pressure edges.",
          "Hold onto the person next to you and use them as a brace against the movement.",
          "Stand still, lock your knees, and use your core strength to resist being pushed."
        ], a: 1 },
      { q: "You realize the crowd density has reached a point where you cannot control your movement, but you are still standing. What is the most effective breathing technique to employ?", options: [
          "Taking slow, deep, controlled breaths while trying to keep your head above the highest point of the crowd.",
          "Yelling a single word for help between each breath.",
          "Hyperventilating with short, quick breaths to maximize oxygen intake.",
          "Holding your breath for as long as possible until a movement break occurs."
        ], a: 0 },
      { q: "At what crowd density, in people per square meter, does the force become strong enough to potentially break ribs, signaling a critical level of danger?", options: [
          "4 to 5 people per square meter.",
          "6 people per square meter.",
          "3 people per square meter.",
          "8 or more people per square meter."
        ], a: 0 },
      { q: "If you begin to feel truly overwhelmed by the crowd's density and pressure, but you can still move your feet, what is the best immediate preventative action?", options: [
          "Lower your body into a wide squat to maintain a lower center of gravity.",
          "Tightly grab the hand of the nearest person to maintain your stability.",
          "Wait for a natural pause in the crowd movement before attempting to exit.",
          "Move immediately and determinedly toward the edges or the nearest exit point."
        ], a: 3 },
      { q: "You trip and fall in a crowd crush. What is your absolute first priority, before all else?", options: [
          "Protecting your head and neck with your hands and arms.",
          "Immediately finding a way to get back up onto your feet.",
          "Shifting onto your stomach to reduce the surface area being trampled.",
          "Curling into a ball on your left side to protect your lungs."
        ], a: 0 },
      { q: "If you fall down and it is impossible to get back up, which specific position and side is recommended to protect your vital organs?", options: [
          "Lying on your right side, facing the flow of the crowd.",
          "Lying on your back with your legs curled up to protect your abdomen.",
          "Curling into a ball on your left side to protect your head and chest.",
          "Lying on your stomach and interlocking your fingers over the back of your head."
        ], a: 2 },
      { q: "What is the strategic purpose of moving with the crowd's flow instead of fighting against it?", options: [
          "To find a friendlier group of people who are also moving in the same direction.",
          "To conserve the limited energy required for defensive actions and long-term movement.",
          "To allow time for the people pushing you to eventually run out of energy and stop.",
          "To reduce friction between yourself and others, making it easier to slip through gaps."
        ], a: 1 },
      { q: "If all ground-level escape routes are blocked by a dense, surging crowd, what is a vertical escape method suggested in the video?", options: [
          "Climbing onto a fence, barrier, or a sturdy object like a tree.",
          "Jumping high during lulls to attract the attention of venue security or staff.",
          "Attempting to climb over the backs of the nearest individuals in front of you.",
          "Lying down and allowing the crowd to pass over you to avoid the main force."
        ], a: 0 }
    ];

    const MODULE_ID = 6;
    const ASSIGNMENT_NUMBER = 7;
    const TOTAL_ASSIGNMENTS = 15;

    const quizForm = document.getElementById('quizForm');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultModal = document.getElementById('resultModal');
    const modalMsg = document.getElementById('modalMsg');
    const modalOk = document.getElementById('modalOk');
    const completedCountEl = document.getElementById('completedCount');
    const lastScoreEl = document.getElementById('lastScore');
    const avgScoreEl = document.getElementById('avgScore');
    const progressText = document.getElementById('progressText');
    const progressArc = document.getElementById('progressArc');

    // helper: get JWT token from sessionStorage
    function getToken(){ return sessionStorage.getItem('lifesafe_access'); }

    // simple fetch wrapper to backend (same-origin)
    async function apiFetch(path, method='GET', body=null){
      const headers = {};
      const token = getToken();
      if(token) headers['Authorization'] = 'Bearer ' + token;
      if(body) headers['Content-Type'] = 'application/json';
      const opts = { method, headers };
      if(body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(window.location.origin + path, opts);
        const data = await res.json().catch(()=>({ok:false}));
        return { status: res.status, data };
      } catch (err) {
        return { status: 0, data: { ok:false, message: 'Network error' } };
      }
    }

    function renderQuestions(){
      QUESTIONS.forEach((item, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question';
        qDiv.innerHTML = `<h4>Q${idx+1}. ${item.q}</h4><div class="options"></div>`;
        const opts = qDiv.querySelector('.options');
        item.options.forEach((opt, oi) => {
          const label = document.createElement('label');
          label.className = 'opt';
          label.innerHTML = `<input type="radio" name="q${idx}" value="${oi}"> <span style="font-size:14px">${opt}</span>`;
          opts.appendChild(label);
        });
        quizForm.appendChild(qDiv);
      });
    }

    async function loadProgress(){
      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      if(res.status === 200 && res.data.ok){
        const p = res.data;
        const done = (p.completed || []).length;
        completedCountEl.textContent = `${done} / ${TOTAL_ASSIGNMENTS}`;
        lastScoreEl.textContent = (p.scores && p.scores[ASSIGNMENT_NUMBER] !== undefined) ? `${p.scores[ASSIGNMENT_NUMBER]} / ${QUESTIONS.length}` : '—';
        const arr = Object.values(p.scores || {}).filter(v => typeof v === 'number');
        avgScoreEl.textContent = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) + ` / ${QUESTIONS.length}` : '—';
        // update ring
        const pct = Math.round((done / TOTAL_ASSIGNMENTS) * 100);
        progressText.textContent = pct + '%';
        const circumference = 100;
        const dash = Math.round((pct/100) * circumference);
        progressArc.setAttribute('stroke-dasharray', `${dash} ${circumference - dash}`);
      }
    }

    async function saveProgress(state){
      await apiFetch(`/api/module/${MODULE_ID}/progress`, 'POST', state);
    }

    function validateAnswers(){
      for(let i=0;i<QUESTIONS.length;i++){
        if(!document.querySelector(`input[name=q${i}]:checked`)) return false;
      }
      return true;
    }

    async function gradeAndSave(){
      let score = 0;
      QUESTIONS.forEach((item, idx) => {
        const el = document.querySelector(`input[name=q${idx}]:checked`);
        const chosen = el ? parseInt(el.value, 10) : null;
        const qDiv = el ? el.closest('.question') : document.getElementsByClassName('question')[idx];
        if(chosen === item.a){
          score++;
          if(qDiv){ qDiv.classList.remove('incorrect'); qDiv.classList.add('correct'); }
        } else {
          if(qDiv){ qDiv.classList.remove('correct'); qDiv.classList.add('incorrect'); }
        }
      });

      // load existing progress then update + post
      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      const state = (res.status === 200 && res.data.ok) ? res.data : { completed: [], scores: {} };
      state.completed = state.completed || [];
      state.scores = state.scores || {};
      if(!state.completed.includes(ASSIGNMENT_NUMBER)) state.completed.push(ASSIGNMENT_NUMBER);
      state.scores[ASSIGNMENT_NUMBER] = score;
      await saveProgress({ completed: state.completed, scores: state.scores });

      modalMsg.textContent = `You scored ${score} / ${QUESTIONS.length}`;
      resultModal.style.display = 'flex';
      await loadProgress();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitted ✓';
    }

    submitBtn.addEventListener('click', async function(){
      if(!getToken()){ alert('Please login to submit answers.'); return; }
      if(!validateAnswers()){ alert('Please answer all questions before submitting.'); return; }
      await gradeAndSave();
    });

    clearBtn.addEventListener('click', function(){
      document.querySelectorAll('input[type=radio]').forEach(r=>r.checked=false);
      document.querySelectorAll('.question').forEach(q=>{ q.classList.remove('correct','incorrect'); });
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Answers';
    });

    modalOk.addEventListener('click', function(){
      resultModal.style.display = 'none';
      window.location.href = 'module6.html';
    });

    // init
    renderQuestions();
    loadProgress();
  </script>
</body>
</html>