<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Module 6 — Assignment 6: Movement & Escape</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{
      --bg:#07102a; --card:#0f1724; --muted:#cfe5ff;
      --accent:#ff6b35; --success:#22c55e; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03); --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg), #021024);color:#e6f0ff;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 380px;gap:20px}
    .left,.right{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{margin:0;font-size:20px;color:var(--accent)}
    .sub{color:var(--muted);font-size:13px}
    .video-wrap{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .video-embed{width:100%;height:0;padding-bottom:56.25%;position:relative;border-radius:8px;overflow:hidden}
    .video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    form.quiz{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .question{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}
    .question h4{margin:0 0 8px;font-size:14px}
    .opt{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,0.02)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .note{font-size:13px;color:var(--muted)}
    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .stats{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.5),rgba(2,6,23,0.6))}
    .modal-inner{background:var(--card);padding:20px;border-radius:12px;width:360px;text-align:center}
    .close-btn{background:#fff;color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .progress-ring{width:200px;height:200px;margin:10px auto}
    .correct{border-left:6px solid var(--success)} .incorrect{border-left:6px solid var(--danger)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}.right{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <header>
        <div>
          <h1>Module 6 • Crowd Safety</h1>
          <div class="sub">Assignment 6 — Movement & Escape (Video)</div>
        </div>
        <div style="text-align:right">
          <div class="sub">Est. time: <strong>6–8 min</strong></div>
          <a class="btn ghost" href="module6.html" style="margin-top:8px;display:inline-block">Back to Module</a>
        </div>
      </header>

      <div class="video-wrap">
        <div class="video-embed" aria-hidden="false">
          <iframe src="https://www.youtube.com/embed/MSiw9ZGdtSQ" title="Movement & Escape" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>

      <form class="quiz" id="quizForm" aria-label="Quiz for Assignment 6"></form>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="note">Each question: <strong>1 mark</strong>. Total: 10 marks.</div>
        <div class="actions">
          <button class="btn" id="submitBtn" type="button">Submit Answers</button>
          <button class="btn ghost" id="clearBtn" type="button">Reset Answers</button>
        </div>
      </div>
    </div>

    <aside class="right" aria-label="Progress & Stats">
      <div class="card-title">
        <div><strong style="color:var(--muted)">Progress</strong><div style="font-size:12px;color:#bcd8ff">Module 6 — Crowd Safety</div></div>
        <div style="font-size:12px;color:var(--muted)">Assignment 6</div>
      </div>

      <div style="text-align:center">
        <svg viewBox="0 0 36 36" class="progress-ring" id="progressSvg" aria-hidden>
          <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#374151" stroke-width="3.5"></path>
          <path id="progressArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#22c55e" stroke-width="3.5" stroke-dasharray="0 100"></path>
          <text x="18" y="20.5" font-size="6" text-anchor="middle" fill="#fff" id="progressText">0%</text>
        </svg>
      </div>

      <div class="stats">
        <div class="stat"><div style="font-size:14px">Completed Assignments</div><div id="completedCount">0 / 15</div></div>
        <div class="stat"><div style="font-size:14px">Your score (this assignment)</div><div id="lastScore">—</div></div>
        <div class="stat"><div style="font-size:14px">Module Avg. (so far)</div><div id="avgScore">—</div></div>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">
        Tip: Practice the 'boxer stance' and map exits before attending crowded events.
      </div>
    </aside>
  </div>

  <div class="modal" id="resultModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-inner" role="document">
      <h3>Result</h3>
      <p id="modalMsg">You scored X / 10</p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="close-btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Assignment 6 questions (Module 6)
    const QUESTIONS = [
      { q: "According to the video, what is the primary cause of casualties in a crowd crush?", options: [
          "The force of the crowd breaking bones.",
          "Compressive Asphyxia, or being pressed so tightly that you cannot breathe.",
          "Injuries sustained from falling and hitting hard surfaces.",
          "Being trampled by people running over you."
        ], a: 1 },
      { q: "Which specific body position is recommended to protect your chest and create breathing space in a high-pressure crowd?", options: [
          "Holding your arms straight up above your head to signal for help.",
          "Pushing your hands forward to fight against the crowd flow.",
          "Folding your arms across your rib cage like a boxer.",
          "Lying on your back to distribute pressure evenly."
        ], a: 2 },
      { q: "According to safety experts mentioned, at what density (people per square meter) does movement become difficult?", options: [
          "7 or more people per square meter.",
          "6 people per square meter.",
          "1 to 2 people per square meter.",
          "4 to 5 people per square meter."
        ], a: 3 },
      { q: "What is the recommended breathing strategy if you find yourself trapped in a packed crowd?", options: [
          "Taking quick, shallow breaths to minimize chest expansion.",
          "Controlling your breathing and taking slow, deep breaths.",
          "Holding your breath for as long as possible.",
          "Screaming loudly for help to draw attention."
        ], a: 1 },
      { q: "Before even arriving at a large event, what essential preparedness step is recommended?", options: [
          "Taking note of all the closest restaurants and restrooms.",
          "Researching the venue in advance and taking note of entrances and exits.",
          "Practicing the 'boxer stance' at home for 15 minutes.",
          "Bringing a loud whistle or alarm to signal for help."
        ], a: 1 },
      { q: "If you find yourself in a surging crowd, what is the best strategy regarding the flow of people?", options: [
          "Pushing back hard against the force to establish your position.",
          "Stopping completely and locking your feet to resist movement.",
          "Trying to move in the opposite direction of the crowd flow.",
          "Moving with the crowd while staying on your feet and gradually working toward the edges."
        ], a: 3 },
      { q: "If the crowd starts to feel overwhelming, but you are not yet trapped, what should your immediate next step be?", options: [
          "Dropping into the fetal position to protect your head and chest.",
          "Moving toward the edges or an exit before the situation worsens.",
          "Yelling at the people around you to stop pushing.",
          "Immediately trying to climb onto someone's shoulders to gain a vantage point."
        ], a: 1 },
      { q: "If you fall down during a crowd crush, what is your first priority?", options: [
          "Tucking your arms into the boxer stance.",
          "Finding a way to get back up immediately.",
          "Screaming and rolling onto your back for maximum protection.",
          "Covering your head and waiting for the crowd to pass."
        ], a: 1 },
      { q: "If getting back up is impossible after falling, what specific body position and side do some experts recommend to protect your lungs?", options: [
          "Pushing your hands on the ground and trying to crawl out.",
          "Lying on your left side, curled into a ball to protect the head and chest.",
          "Lying flat on your stomach, covering your neck.",
          "Lying on your right side, curling into a ball."
        ], a: 1 },
      { q: "What is mentioned as a physical method to escape a dense crowd if conventional exit routes are blocked?", options: [
          "Using your jacket to push people away and clear a path.",
          "Squeezing through the legs of other attendees.",
          "Climbing onto a fence, barrier, or even a tree.",
          "Waiting patiently for a movement break, then sprinting out."
        ], a: 2 }
    ];

    const MODULE_ID = 6;
    const ASSIGNMENT_NUMBER = 6;
    const TOTAL_ASSIGNMENTS = 15;

    const quizForm = document.getElementById('quizForm');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultModal = document.getElementById('resultModal');
    const modalMsg = document.getElementById('modalMsg');
    const modalOk = document.getElementById('modalOk');
    const completedCountEl = document.getElementById('completedCount');
    const lastScoreEl = document.getElementById('lastScore');
    const avgScoreEl = document.getElementById('avgScore');
    const progressText = document.getElementById('progressText');
    const progressArc = document.getElementById('progressArc');

    // helper: get JWT token from sessionStorage
    function getToken(){ return sessionStorage.getItem('lifesafe_access'); }

    // simple fetch wrapper to backend (same-origin)
    async function apiFetch(path, method='GET', body=null){
      const headers = {};
      const token = getToken();
      if(token) headers['Authorization'] = 'Bearer ' + token;
      if(body) headers['Content-Type'] = 'application/json';
      const opts = { method, headers };
      if(body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(window.location.origin + path, opts);
        const data = await res.json().catch(()=>({ok:false}));
        return { status: res.status, data };
      } catch (err) {
        return { status: 0, data: { ok:false, message: 'Network error' } };
      }
    }

    function renderQuestions(){
      QUESTIONS.forEach((item, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question';
        qDiv.innerHTML = `<h4>Q${idx+1}. ${item.q}</h4><div class="options"></div>`;
        const opts = qDiv.querySelector('.options');
        item.options.forEach((opt, oi) => {
          const label = document.createElement('label');
          label.className = 'opt';
          label.innerHTML = `<input type="radio" name="q${idx}" value="${oi}"> <span style="font-size:14px">${opt}</span>`;
          opts.appendChild(label);
        });
        quizForm.appendChild(qDiv);
      });
    }

    async function loadProgress(){
      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      if(res.status === 200 && res.data.ok){
        const p = res.data;
        const done = (p.completed || []).length;
        completedCountEl.textContent = `${done} / ${TOTAL_ASSIGNMENTS}`;
        lastScoreEl.textContent = (p.scores && p.scores[ASSIGNMENT_NUMBER] !== undefined) ? `${p.scores[ASSIGNMENT_NUMBER]} / ${QUESTIONS.length}` : '—';
        const arr = Object.values(p.scores || {}).filter(v => typeof v === 'number');
        avgScoreEl.textContent = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) + ` / ${QUESTIONS.length}` : '—';
        // update ring
        const pct = Math.round((done / TOTAL_ASSIGNMENTS) * 100);
        progressText.textContent = pct + '%';
        const circumference = 100;
        const dash = Math.round((pct/100) * circumference);
        progressArc.setAttribute('stroke-dasharray', `${dash} ${circumference - dash}`);
      }
    }

    async function saveProgress(state){
      await apiFetch(`/api/module/${MODULE_ID}/progress`, 'POST', state);
    }

    function validateAnswers(){
      for(let i=0;i<QUESTIONS.length;i++){
        if(!document.querySelector(`input[name=q${i}]:checked`)) return false;
      }
      return true;
    }

    async function gradeAndSave(){
      let score = 0;
      QUESTIONS.forEach((item, idx) => {
        const el = document.querySelector(`input[name=q${idx}]:checked`);
        const chosen = el ? parseInt(el.value, 10) : null;
        const qDiv = el ? el.closest('.question') : document.getElementsByClassName('question')[idx];
        if(chosen === item.a){
          score++;
          if(qDiv){ qDiv.classList.remove('incorrect'); qDiv.classList.add('correct'); }
        } else {
          if(qDiv){ qDiv.classList.remove('correct'); qDiv.classList.add('incorrect'); }
        }
      });

      // load existing progress then update + post
      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      const state = (res.status === 200 && res.data.ok) ? res.data : { completed: [], scores: {} };
      state.completed = state.completed || [];
      state.scores = state.scores || {};
      if(!state.completed.includes(ASSIGNMENT_NUMBER)) state.completed.push(ASSIGNMENT_NUMBER);
      state.scores[ASSIGNMENT_NUMBER] = score;
      await saveProgress({ completed: state.completed, scores: state.scores });

      modalMsg.textContent = `You scored ${score} / ${QUESTIONS.length}`;
      resultModal.style.display = 'flex';
      await loadProgress();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitted ✓';
    }

    submitBtn.addEventListener('click', async function(){
      if(!getToken()){ alert('Please login to submit answers.'); return; }
      if(!validateAnswers()){ alert('Please answer all questions before submitting.'); return; }
      await gradeAndSave();
    });

    clearBtn.addEventListener('click', function(){
      document.querySelectorAll('input[type=radio]').forEach(r=>r.checked=false);
      document.querySelectorAll('.question').forEach(q=>{ q.classList.remove('correct','incorrect'); });
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Answers';
    });

    modalOk.addEventListener('click', function(){
      resultModal.style.display = 'none';
      window.location.href = 'module6.html';
    });

    // init
    renderQuestions();
    loadProgress();
  </script>
</body>
</html>