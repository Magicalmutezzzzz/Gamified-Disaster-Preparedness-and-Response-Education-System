<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login / Register — LIFESAFE</title>
  <meta name="description" content="Login or register for Lifesafe — gamified disaster preparedness for schools & colleges.">
  <style>
    :root{
      --accent:#ff6b35;
      --bg:#07102a;
      --card:#0f1724;
      --muted:#cfe5ff;
      --maxw:960px;
      --focus: 0 0 0 4px rgba(255,107,53,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;background:linear-gradient(180deg,var(--bg), #051027);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{padding:14px}
    h2{margin:0 0 10px 0}
    p.small{margin:6px 0 12px 0;color:var(--muted);opacity:0.9;font-size:13px}

    form{display:grid;gap:10px}
    label{font-size:13px;color:#dbeafe}
    input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    input::placeholder{color:rgba(255,255,255,0.5)}
    .row{display:flex;gap:10px}
    .half{flex:1}
    .btn{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);width:auto;padding:10px 12px}
    .hint{font-size:12px;color:#cfe5ff;opacity:0.85;margin-top:6px}

    .status{padding:8px;border-radius:8px;font-size:13px;display:none}
    .ok{background:rgba(34,197,94,0.12);color:#a7f3d0;border:1px solid rgba(34,197,94,0.12)}
    .err{background:rgba(248,113,113,0.08);color:#fecaca;border:1px solid rgba(248,113,113,0.06)}

    .google-btn{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;background:transparent}
    .google-btn:focus{outline:none;box-shadow:var(--focus)}
    .small-note{font-size:12px;color:#cfe5ff;opacity:0.85;margin-top:10px}

    a.link{color:#cfe5ff;text-decoration:underline}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    @media (prefers-reduced-motion: reduce){ * { animation: none !important } }
    :focus { outline: none; box-shadow: var(--focus); border-color: rgba(255,107,53,0.9); }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="font-weight:800;color:var(--accent)">LIFESAFE</div>
        <div style="color:#cfe5ff;opacity:0.9">Disaster Preparedness</div>
      </div>
      <a href="index.html" class="btn btn-sm btn-ghost" style="text-decoration:none;color:inherit">Back to Launchpad</a>
    </header>

    <div class="grid" aria-live="polite">
      <!-- Left: Register -->
      <div class="card panel" aria-labelledby="regHeading">
        <h2 id="regHeading">Register</h2>
        <p class="small">Create a student account. Fields marked * are required.</p>

        <form id="registerForm" autocomplete="off" novalidate>
          <label for="studentName">Student Name *</label>
          <input name="studentName" id="studentName" required placeholder="Full name" aria-required="true" />

          <div class="row">
            <div class="half">
              <label for="dob">Date of Birth *</label>
              <input name="dob" id="dob" type="date" required aria-required="true" />
            </div>
            <div class="half">
              <label for="idNo">Aadhar / ID No *</label>
              <input name="idNo" id="idNo" placeholder="1234 5678 9012" required aria-required="true" />
            </div>
          </div>

          <label for="school">School / College *</label>
          <input name="school" id="school" placeholder="Name of institution" required />

          <div class="row">
            <div class="half">
              <label for="father">Father's Name</label>
              <input name="father" id="father" placeholder="Father's name" />
            </div>
            <div class="half">
              <label for="contact">Contact No *</label>
              <input name="contact" id="contact" placeholder="+91 98xxxxxxxx" required />
            </div>
          </div>

          <label for="emergency">Emergency Contact No *</label>
          <input name="emergency" id="emergency" placeholder="+91 98xxxxxxxx" required />

          <label for="regEmail">Email ID *</label>
          <input name="email" id="regEmail" type="email" placeholder="student@example.com" required />

          <div class="row">
            <div class="half">
              <label for="password">Password *</label>
              <input name="password" id="password" type="password" placeholder="Choose a strong password" required />
            </div>
            <div class="half">
              <label for="rpassword">Retype Password *</label>
              <input name="rpassword" id="rpassword" type="password" placeholder="Retype password" required />
            </div>
          </div>

          <div id="passMatch" class="status" aria-live="polite"></div>

          <div style="display:flex;gap:10px;margin-top:6px;align-items:center">
            <button type="submit" class="btn" id="registerBtn">Register & Save</button>
            <button type="button" id="clearLocal" class="btn ghost">Clear Session</button>
          </div>

          <div class="hint" style="margin-top:10px">After registration you will be logged in automatically and redirected.</div>
        </form>
      </div>

      <!-- Right: Login -->
      <div class="card panel" aria-labelledby="loginHeading">
        <h2 id="loginHeading">Login</h2>
        <p class="small">Login with Google (recommended) or Email & Password</p>

        <!-- Google Sign-In (official button will render here) -->
        <div id="gSignWrap" style="margin-bottom:12px"></div>

        <form id="loginForm" autocomplete="off" novalidate>
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="student@example.com" required />

          <label for="loginPass">Password</label>
          <input id="loginPass" type="password" placeholder="Password" required />

          <div style="display:flex;gap:10px;margin-top:10px">
            <button type="submit" class="btn" id="loginBtn">Login</button>
            <button type="button" id="demoPopulate" class="btn ghost">Fill demo user</button>
          </div>
          <div id="loginStatus" class="status" aria-live="polite" style="margin-top:10px"></div>
        </form>

        <div class="small-note" style="margin-top:12px">
          Don't have an account? Use the Register form at left. Admins can login at <a class="link" href="admin.html">/admin</a>.
        </div>
      </div>
    </div>
  </div>

  <script>
    /******************************************
     * CONFIG - Update if needed
     ******************************************/
    // If your frontend and backend are served from the same origin (Render), we use location.origin.
    // If backend is deployed separately, replace with full URL: e.g., 'https://your-backend.onrender.com'
    const API_BASE = "https://gamified-disaster-preparedness-and.onrender.com";

    // Google client id (must match backend GOOGLE_CLIENT_ID env and Authorized JS origins)
    const GOOGLE_CLIENT_ID = '299186708270-r8aa0errs6ph78ktk3672blvj1i4uvut.apps.googleusercontent.com';

    /******************************************
     * Helpers
     ******************************************/
    function qs(name, url = window.location.href){
      name = name.replace(/[[]]/g, "\\$&");
      const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    function showStatus(el, msg, ok=true){
      el.style.display = 'block';
      el.textContent = msg;
      el.className = 'status ' + (ok ? 'ok' : 'err');
    }
    function hideStatus(el){
      el.style.display = 'none';
      el.textContent = '';
      el.className = 'status';
    }
    function parseJwt(token){
      try{
        const payload = token.split('.')[1];
        return JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
      }catch(e){ return null; }
    }
    function tokenValid(token){
      if(!token) return false;
      const p = parseJwt(token);
      if(!p) return true;
      if(p.exp && (Date.now()/1000) > p.exp) return false;
      return true;
    }

    /******************************************
     * DOM refs
     ******************************************/
    const registerForm = document.getElementById('registerForm');
    const pass = document.getElementById('password');
    const rpass = document.getElementById('rpassword');
    const passMatch = document.getElementById('passMatch');
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');

    /******************************************
     * Password match UI
     ******************************************/
    function updatePassMatch(){
      const p = pass.value;
      const r = rpass.value;
      if(!p && !r){ passMatch.style.display='none'; return; }
      passMatch.style.display='block';
      if(p === r){
        passMatch.textContent = 'Passwords match ✓';
        passMatch.className = 'status ok';
      } else {
        passMatch.textContent = 'Passwords do not match ✖';
        passMatch.className = 'status err';
      }
    }
    pass && pass.addEventListener('input', updatePassMatch);
    rpass && rpass.addEventListener('input', updatePassMatch);

    /******************************************
     * API helpers
     ******************************************/
    async function apiPost(path, body, token){
      try{
        const headers = {'Content-Type':'application/json'};
        if(token) headers['Authorization'] = 'Bearer ' + token;
        const res = await fetch(API_BASE + path, { method: 'POST', headers, body: JSON.stringify(body) });
        const data = await res.json().catch(()=>({ok:false, message:'Invalid JSON from server'}));
        return { status: res.status, data };
      }catch(err){
        return { status: 0, data: { ok:false, message: 'Network error: '+err.message } };
      }
    }
    async function apiGet(path, token){
      try{
        const headers = {};
        if(token) headers['Authorization'] = 'Bearer ' + token;
        const res = await fetch(API_BASE + path, { method: 'GET', headers });
        const data = await res.json().catch(()=>({ok:false, message:'Invalid JSON from server'}));
        return { status: res.status, data };
      }catch(err){
        return { status: 0, data: { ok:false, message: 'Network error: '+err.message } };
      }
    }

    function redirectAfterAuth(){
      const next = qs('next') || 'training.html';
      window.location.href = next;
    }

    /******************************************
     * Registration handler
     ******************************************/
    registerForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const user = {
        studentName: document.getElementById('studentName').value.trim(),
        dob: document.getElementById('dob').value || null,
        idNo: document.getElementById('idNo').value.trim(),
        school: document.getElementById('school').value.trim(),
        father: document.getElementById('father').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        emergency: document.getElementById('emergency').value.trim(),
        email: document.getElementById('regEmail').value.trim().toLowerCase(),
        password: pass.value
      };
      if(!user.studentName || !user.dob || !user.idNo || !user.school || !user.contact || !user.emergency || !user.email || !user.password){
        alert('Please fill all required fields.');
        return;
      }
      if(user.password !== rpass.value){
        alert('Passwords do not match.');
        return;
      }

      const res = await apiPost('/api/register', user);
      if(res.status === 201 && res.data && res.data.ok){
        sessionStorage.setItem('lifesafe_access', res.data.access);
        alert('Registration successful — you are now logged in.');
        registerForm.reset();
        passMatch.style.display = 'none';
        redirectAfterAuth();
        return;
      }
      const errMsg = (res.data && (res.data.message || JSON.stringify(res.data))) || 'Registration failed';
      alert('Registration error: ' + errMsg);
    });

    /******************************************
     * Login handler (email/password)
     ******************************************/
    loginForm.addEventListener('submit', async function(e){
      e.preventDefault();
      hideStatus(loginStatus);
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const pwd = document.getElementById('loginPass').value;
      if(!email || !pwd){ showStatus(loginStatus, 'Provide email and password.', false); return; }

      const res = await apiPost('/api/login', { email, password: pwd });
      if(res.status === 200 && res.data && res.data.ok){
        sessionStorage.setItem('lifesafe_access', res.data.access);
        showStatus(loginStatus, 'Login successful — redirecting...', true);
        setTimeout(redirectAfterAuth, 700);
        return;
      }
      const msg = (res.data && res.data.message) || 'Invalid credentials';
      showStatus(loginStatus, msg, false);
    });

    /******************************************
     * Demo user button
     ******************************************/
    document.getElementById('demoPopulate').addEventListener('click', async function(){
      const demoEmail = 'demo.student@example.com';
      const demoPassword = 'Demo@1234';
      const tryLogin = await apiPost('/api/login', { email: demoEmail, password: demoPassword });
      if(tryLogin.status === 200 && tryLogin.data && tryLogin.data.ok){
        sessionStorage.setItem('lifesafe_access', tryLogin.data.access);
        alert('Demo user exists — logged in.');
        redirectAfterAuth();
        return;
      }
      const payload = {
        studentName: 'Demo Student',
        dob: '2005-01-01',
        idNo: '000000000000',
        school: 'Demo College',
        father: 'Demo Father',
        contact: '+919800000000',
        emergency: '+919800000001',
        email: demoEmail,
        password: demoPassword
      };
      const reg = await apiPost('/api/register', payload);
      if(reg.status === 201 && reg.data && reg.data.ok){
        sessionStorage.setItem('lifesafe_access', reg.data.access);
        alert('Demo user created and logged in.');
        redirectAfterAuth();
        return;
      }
      alert('Demo populate failed: ' + (reg.data && (reg.data.message || JSON.stringify(reg.data))));
    });

    /******************************************
     * Clear session
     ******************************************/
    document.getElementById('clearLocal').addEventListener('click', function(){
      if(confirm('This will clear the current session token from your browser. Continue?')){
        sessionStorage.removeItem('lifesafe_access');
        alert('Session cleared.');
      }
    });

    /******************************************
     * REAL Google Sign-In integration (ID token flow)
     * - Requires GOOGLE_CLIENT_ID on server and in Google Cloud Console.
     * - When user signs in, Google returns an ID token (JWT) as resp.credential
     * - We POST { id_token: resp.credential } to /api/google-signin
     ******************************************/
    // Load the Google Identity Services script (already included below).
    // We initialize the Google button and callback after script loads.
    async function initGoogleSignIn(){
      if(!window.google || !google.accounts || !google.accounts.id){
        console.warn('Google Identity script not available yet.');
        return;
      }
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: async (resp) => {
          // resp.credential contains the id_token string
          if(!resp || !resp.credential){
            alert('Google sign-in did not return a credential.');
            return;
          }
          // Send id_token to backend for verification and JWT issuance
          const serverRes = await apiPost('/api/google-signin', { id_token: resp.credential });
          if(serverRes.status === 200 && serverRes.data && serverRes.data.ok){
            sessionStorage.setItem('lifesafe_access', serverRes.data.access);
            redirectAfterAuth();
            return;
          }
          // show failure
          alert('Google sign-in failed: ' + (serverRes.data && serverRes.data.message));
        }
      });

      // Render the Google button into #gSignWrap
      google.accounts.id.renderButton(
        document.getElementById('gSignWrap'),
        { theme: 'outline', size: 'large', width: '320' }  // customization
      );

      // Optionally show the One Tap prompt (commented by default)
      // google.accounts.id.prompt();
    }

    // Initialize when script loaded
    window.addEventListener('load', function(){
      // If Google script already loaded and global available, init now
      if(window.google && google.accounts && google.accounts.id){
        initGoogleSignIn();
      } else {
        // otherwise wait for script to load (onload handler below)
      }
    });

    // When the google script loads it will call this
    function onGoogleClientLoaded(){
      initGoogleSignIn();
    }

    // Auto clean expired token
    (function(){
      const token = sessionStorage.getItem('lifesafe_access');
      if(token && !tokenValid(token)) sessionStorage.removeItem('lifesafe_access');
    })();

    console.log('Auth page active — API_BASE =', API_BASE);
  </script>

  <!-- Google Identity Services: real sign-in. File loaded from Google -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="onGoogleClientLoaded()"></script>
</body>
</html>
