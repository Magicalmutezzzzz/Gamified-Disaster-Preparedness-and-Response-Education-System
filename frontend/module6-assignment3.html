<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Module 6 — Assignment 3: Conversational Oxygen & Communication</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{
      --bg:#07102a; --card:#0f1724; --muted:#cfe5ff;
      --accent:#ff6b35; --success:#22c55e; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03); --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg), #021024);color:#e6f0ff;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 380px;gap:20px}
    .left,.right{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{margin:0;font-size:20px;color:var(--accent)}
    .sub{color:var(--muted);font-size:13px}
    .video-wrap{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .video-embed{width:100%;height:0;padding-bottom:56.25%;position:relative;border-radius:8px;overflow:hidden}
    .video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    form.quiz{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .question{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}
    .question h4{margin:0 0 8px;font-size:14px}
    .opt{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,0.02)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .note{font-size:13px;color:var(--muted)}
    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .stats{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.5),rgba(2,6,23,0.6))}
    .modal-inner{background:var(--card);padding:20px;border-radius:12px;width:360px;text-align:center}
    .close-btn{background:#fff;color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .progress-ring{width:200px;height:200px;margin:10px auto}
    .correct{border-left:6px solid var(--success)} .incorrect{border-left:6px solid var(--danger)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}.right{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <header>
        <div>
          <h1>Module 6 • Crowd Safety</h1>
          <div class="sub">Assignment 3 — Conversational Oxygen & Communication</div>
        </div>
        <div style="text-align:right">
          <div class="sub">Est. time: <strong>6–8 min</strong></div>
          <a class="btn ghost" href="module6.html" style="margin-top:8px;display:inline-block">Back to Module</a>
        </div>
      </header>

      <div class="video-wrap">
        <div class="video-embed" aria-hidden="false">
          <iframe src="https://www.youtube.com/embed/tHq9yQOKx6k"
            title="Conversational Oxygen & Communication" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>

      <form class="quiz" id="quizForm" aria-label="Quiz for Assignment 3"></form>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="note">Each question: <strong>1 mark</strong>. Total: 10 marks.</div>
        <div class="actions">
          <button class="btn" id="submitBtn" type="button">Submit Answers</button>
          <button class="btn ghost" id="clearBtn" type="button">Reset Answers</button>
        </div>
      </div>
    </div>

    <aside class="right" aria-label="Progress & Stats">
      <div class="card-title">
        <div><strong style="color:var(--muted)">Progress</strong><div style="font-size:12px;color:#bcd8ff">Module 6 — Crowd Safety</div></div>
        <div style="font-size:12px;color:var(--muted)">Assignment 3</div>
      </div>

      <div style="text-align:center">
        <svg viewBox="0 0 36 36" class="progress-ring" id="progressSvg" aria-hidden>
          <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#374151" stroke-width="3.5"></path>
          <path id="progressArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#22c55e" stroke-width="3.5" stroke-dasharray="0 100"></path>
          <text x="18" y="20.5" font-size="6" text-anchor="middle" fill="#fff" id="progressText">0%</text>
        </svg>
      </div>

      <div class="stats">
        <div class="stat"><div style="font-size:14px">Completed Assignments</div><div id="completedCount">0 / 15</div></div>
        <div class="stat"><div style="font-size:14px">Your score (this assignment)</div><div id="lastScore">—</div></div>
        <div class="stat"><div style="font-size:14px">Module Avg. (so far)</div><div id="avgScore">—</div></div>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">
        Tip: "Listen between the lines" — focus on head/eyes/heart to build trust. Watch the video for the CO5 framework.
      </div>
    </aside>
  </div>

  <div class="modal" id="resultModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-inner" role="document">
      <h3>Result</h3>
      <p id="modalMsg">You scored X / 10</p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="close-btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Assignment 3 questions
    const QUESTIONS = [
      { q: "The video opens by stating the biggest challenge with communication is what?", options: ["The illusion that it has taken place.","The tendency for people to monopolize the conversation.","The difficulty of managing emotional responses.","The lack of clear expectations for a follow-up plan."], a: 0 },
      { q: "What is the metaphorical definition of 'conversational oxygen'?", options: ["The ratio of proactive to reactive conversations that a team has.","The energy that brings life into a conversation, similar to how oxygen provides energy to living things.","The volume at which people speak to overcome background noise.","A measurement of the verbal space a speaker gives to a listener."], a: 1 },
      { q: "What is the primary goal of the first element of CO5, 'Listen Between the Lines'?", options: ["To calculate the potential value of the person you are talking to.","To prepare a counter-argument to the speaker's main points.","To memorize and transcribe every word the other person says.","To establish trust by listening with your head, eyes, ears, and heart."], a: 3 },
      { q: "The video suggests that in many conversations, people are not curious, but are instead waiting for what?", options: ["An opportunity to introduce humor and lighten the mood.","The interviewer to ask the next question.","Their chance to shine or get their point in.","The conversation to move to the next topic."], a: 2 },
      { q: "Element 4, 'Create Partnership,' is focused on ending the conversation with a clear understanding of what?", options: ["The precise time and location of the next conversation.","The expectations for the people involved in the conversation.","A detailed written summary of the key discussion points.","Which person gets to speak first in the next meeting."], a: 1 },
      { q: "Which of the following is an example of 'bringing energy into the room' by using conversational oxygen?", options: ["Practicing the Fabulous Five elements to move into proactive conversations.","Ensuring every meeting has a strong cup of coffee available for attendees.","Setting a strict time limit to ensure the conversation ends on time.","Only engaging in 'reactive conversations' when absolutely necessary."], a: 0 },
      { q: "What does John O’Donohue’s quote suggest is the main failing of many conversations in our culture today?", options: ["They are too long and difficult to sustain for weeks afterwards.","They are often interrupted by technology or phone calls.","They involve too much technical jargon and unclear language.","They pass for conversations but are actually just two interesting monologues."], a: 3 },
      { q: "In the context of the CO5 elements, what is the role of 'critical thinking'?", options: ["To calculate the appropriate amount of 'oxygen' needed for the conversation.","To inspire and challenge critical thinking in your own mind and the minds of those you are talking to.","To ensure that you are never surprised by the person you are talking to.","To find logical flaws in the other person's argument before responding."], a: 1 },
      { q: "Element 5, 'Add Value,' is primarily concerned with what two actions in a conversation?", options: ["Setting a meeting agenda and defining the next outcome.","Making jokes and complimenting the other person.","Reading body language and maintaining eye contact.","Giving feedback and receiving feedback."], a: 3 },
      { q: "What concept does the video contrast with a 'transaction' in the final quote, stating that conversations should be the latter?", options: ["A shared discovery.","A debate.","A debate.","A presentation."], a: 0 }
    ];

    const MODULE_ID = 6;
    const ASSIGNMENT_NUMBER = 3;
    const TOTAL_ASSIGNMENTS = 15;

    const quizForm = document.getElementById('quizForm');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultModal = document.getElementById('resultModal');
    const modalMsg = document.getElementById('modalMsg');
    const modalOk = document.getElementById('modalOk');
    const completedCountEl = document.getElementById('completedCount');
    const lastScoreEl = document.getElementById('lastScore');
    const avgScoreEl = document.getElementById('avgScore');
    const progressText = document.getElementById('progressText');
    const progressArc = document.getElementById('progressArc');

    function getToken(){ return sessionStorage.getItem('lifesafe_access'); }

    async function apiFetch(path, method='GET', body=null){
      const headers = {};
      const token = getToken();
      if(token) headers['Authorization'] = 'Bearer ' + token;
      if(body) headers['Content-Type'] = 'application/json';
      const opts = { method, headers };
      if(body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(window.location.origin + path, opts);
        const data = await res.json().catch(()=>({ok:false}));
        return { status: res.status, data };
      } catch (err) {
        return { status: 0, data: { ok:false, message: 'Network error' } };
      }
    }

    function renderQuestions(){
      QUESTIONS.forEach((item, idx) => {
        const q=document.createElement('div'); q.className='question';
        q.innerHTML = `<h4>Q${idx+1}. ${item.q}</h4><div class="options"></div>`;
        const opts = q.querySelector('.options');
        item.options.forEach((o,oi)=> {
          const label=document.createElement('label'); label.className='opt';
          label.innerHTML = `<input type="radio" name="q${idx}" value="${oi}"> <span style="font-size:14px">${o}</span>`;
          opts.appendChild(label);
        });
        quizForm.appendChild(q);
      });
    }

    async function loadProgress(){
      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      if(res.status === 200 && res.data.ok){
        const p = res.data;
        const done = (p.completed || []).length;
        completedCountEl.textContent = `${done} / ${TOTAL_ASSIGNMENTS}`;
        lastScoreEl.textContent = (p.scores && p.scores[ASSIGNMENT_NUMBER] !== undefined) ? `${p.scores[ASSIGNMENT_NUMBER]} / ${QUESTIONS.length}` : '—';
        const arr = Object.values(p.scores || {}).filter(v => typeof v === 'number');
        avgScoreEl.textContent = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) + ` / ${QUESTIONS.length}` : '—';
        const pct = Math.round((done / TOTAL_ASSIGNMENTS) * 100);
        progressText.textContent = pct + '%';
        const circumference = 100;
        const dash = Math.round((pct/100) * circumference);
        progressArc.setAttribute('stroke-dasharray', `${dash} ${circumference - dash}`);
      } else {
        completedCountEl.textContent = `0 / ${TOTAL_ASSIGNMENTS}`;
        lastScoreEl.textContent = '—';
        avgScoreEl.textContent = '—';
      }
    }

    async function saveProgress(state){ await apiFetch(`/api/module/${MODULE_ID}/progress`,'POST',state); }

    function validate(){
      for(let i=0;i<QUESTIONS.length;i++){
        if(!document.querySelector(`input[name=q${i}]:checked`)) return false;
      }
      return true;
    }

    async function gradeAndSave(){
      let score=0;
      QUESTIONS.forEach((it,i)=>{
        const ans=document.querySelector(`input[name=q${i}]:checked`);
        const qDiv = ans ? ans.closest('.question') : document.getElementsByClassName('question')[i];
        if(ans && parseInt(ans.value)===it.a){ score++; qDiv.classList.add('correct'); qDiv.classList.remove('incorrect'); }
        else { qDiv.classList.add('incorrect'); qDiv.classList.remove('correct'); }
      });

      const res = await apiFetch(`/api/module/${MODULE_ID}/progress`);
      const state = (res.status===200 && res.data.ok) ? res.data : { completed: [], scores: {} };
      state.completed = state.completed || [];
      state.scores = state.scores || {};
      if(!state.completed.includes(ASSIGNMENT_NUMBER)) state.completed.push(ASSIGNMENT_NUMBER);
      state.scores[ASSIGNMENT_NUMBER] = score;
      await saveProgress({ completed: state.completed, scores: state.scores });

      modalMsg.textContent = `You scored ${score} / ${QUESTIONS.length}`;
      resultModal.style.display='flex';
      await loadProgress();
      submitBtn.disabled=true; submitBtn.textContent='Submitted ✓';
    }

    submitBtn.onclick=async()=>{
      if(!getToken()){ alert('Login required'); return; }
      if(!validate()){ alert('Please answer all questions'); return; }
      await gradeAndSave();
    };
    clearBtn.onclick=()=>{
      document.querySelectorAll('input[type=radio]').forEach(r=>r.checked=false);
      document.querySelectorAll('.question').forEach(q=>{q.classList.remove('correct','incorrect')});
      submitBtn.disabled=false; submitBtn.textContent='Submit Answers';
    };
    modalOk.onclick=()=>{ resultModal.style.display='none'; window.location.href='module6.html'; };

    // init
    renderQuestions();
    loadProgress();
  </script>
</body>
</html>